---
- name: Remove user from MikroTik routers
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false
  serial: 20
  
  vars:
    # Survey dan keladi yoki default
    username: "{{ remove_username | default('') }}"
  
  tasks:
    # Input validation
    - name: Check if username is provided
      fail:
        msg: "❌ Username is required!"
      when: username == '' or username is not defined
    
    # Safety checks
    - name: Prevent removing critical users
      fail:
        msg: "❌ Cannot remove admin or ansible users!"
      when: username in ['admin', 'ansible']
    
    # Main task
    - name: Check if user exists
      community.routeros.command:
        commands:
          - /user print where name="{{ username }}"
      register: user_check
    
    - name: Remove user
      community.routeros.command:
        commands:
          - /user remove [find name="{{ username }}"]
      when: 
        - user_check.stdout is defined
        - user_check.stdout != ""
      register: user_removed
    
    # Reporting
    - name: Success
      debug:
        msg: "✅ User {{ username }} removed from {{ company | default(inventory_hostname) }}"
      when: user_removed is changed
    
    - name: Not found
      debug:
        msg: "⚠️ User {{ username }} not found on {{ company | default(inventory_hostname) }}"
      when: 
        - user_check.stdout is defined
        - user_check.stdout == ""
```

---
