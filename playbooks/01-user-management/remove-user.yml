---
- name: Remove user from MikroTik routers
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false
  serial: 20
  
  vars:
    username: "{{ remove_username | default('') }}"
  
  tasks:
    - name: Validate username
      fail:
        msg: "❌ Username is required!"
      when: username == ''
      run_once: true
      delegate_to: localhost
    
    - name: Prevent removing critical users
      fail:
        msg: "❌ Cannot remove admin or ansible users!"
      when: username in ['admin', 'ansible']
      run_once: true
      delegate_to: localhost
    
    - name: Check if user exists
      community.routeros.command:
        commands:
          - /user print where name="{{ username }}"
      register: user_check
      ignore_errors: true
    
    - name: Remove user (if exists)
      community.routeros.command:
        commands:
          - /user remove [find name="{{ username }}"]
      when: 
        - user_check is succeeded
        - user_check.stdout is defined
        - user_check.stdout | length > 0
      register: user_removed
      ignore_errors: true
    
    - name: Report - Success
      debug:
        msg: "✅ User '{{ username }}' removed from {{ company | default(inventory_hostname) }}"
      when: 
        - user_removed is defined
        - user_removed is changed
    
    - name: Report - Not found
      debug:
        msg: "⚠️ User '{{ username }}' not found on {{ company | default(inventory_hostname) }}"
      when: 
        - user_check is succeeded
        - user_check.stdout is defined
        - user_check.stdout | length == 0
    
    - name: Report - Connection error
      debug:
        msg: "❌ Connection failed to {{ company | default(inventory_hostname) }}"
      when: user_check is failed
