---
- name: Remove user from MikroTik routers
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false
  serial: 20  # ← 20 ta routerda bir vaqtda bajariladi
  
  vars:
    username: "{{ remove_username }}"
  
  tasks:
    - name: Prevent removing critical users
      fail:
        msg: "❌ Cannot remove admin or ansible users!"
      when: username in ['admin', 'ansible']
    
    - name: Check if user exists
      community.routeros.command:
        commands:
          - /user print where name="{{ username }}"
      register: user_check
    
    - name: Remove user
      community.routeros.command:
        commands:
          - /user remove [find name="{{ username }}"]
      when: user_check.stdout != ""
      register: user_removed
    
    - name: Success message
      debug:
        msg: "✅ {{ username }} removed from {{ inventory_hostname }}"
      when: user_removed is changed
    
    - name: Not found message
      debug:
        msg: "⚠️ {{ username }} not found on {{ inventory_hostname }}"
      when: user_check.stdout == ""
