---
- name: Remove user from MikroTik routers
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false
  serial: 20
  
  vars:
    username: "{{ remove_username | default('') }}"
  
  tasks:
    - name: Validate username
      fail:
        msg: "❌ Username is required!"
      when: username == '' or username is not defined
      run_once: true
      delegate_to: localhost
    
    - name: Prevent removing critical users
      fail:
        msg: "❌ Cannot remove admin or ansible users!"
      when: username in ['admin', 'ansible']
      run_once: true
      delegate_to: localhost
    
    - name: Check if user exists
      community.routeros.command:
        commands:
          - /user print where name="{{ username }}"
      register: user_check
      ignore_errors: true
    
    - name: Debug user_check
      debug:
        var: user_check
      when: ansible_verbosity >= 2
    
    - name: Remove user if exists
      community.routeros.command:
        commands:
          - /user remove [find name="{{ username }}"]
      when: 
        - user_check is succeeded
        - user_check.stdout is defined
        - user_check.stdout | length > 0
        - '": name=' + username in user_check.stdout[0]'
      register: user_removed
      ignore_errors: true
    
    - name: Report success
      debug:
        msg: "✅ User '{{ username }}' removed from {{ company | default(inventory_hostname) }}"
      when: user_removed is changed
    
    - name: Report not found
      debug:
        msg: "⚠️ User '{{ username }}' not found on {{ company | default(inventory_hostname) }}"
      when: 
        - user_check is succeeded
        - user_check.stdout is defined
        - (user_check.stdout | length == 0 or username not in user_check.stdout[0])
    
    - name: Report error
      debug:
        msg: "❌ Failed to check/remove user on {{ company | default(inventory_hostname) }}: {{ user_check.msg | default('Connection error') }}"
      when: user_check is failed
