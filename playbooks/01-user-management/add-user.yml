---
- name: Add user to MikroTik routers
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false
  serial: 20
  
  vars:
    username: "{{ new_username }}"
    password: "{{ new_password }}"
    group: "{{ user_group | default('read') }}"
    comment: "{{ user_comment | default('Created by AWX') }}"
  
  tasks:
    - name: Validate inputs
      fail:
        msg: "❌ Username and password are required!"
      when: username == '' or password == ''
      run_once: true
      delegate_to: localhost
    
    - name: Check password length
      fail:
        msg: "❌ Password must be at least 8 characters!"
      when: password | length < 8
      run_once: true
      delegate_to: localhost
    
    - name: Check if user already exists
      community.routeros.command:
        commands:
          - /user print where name="{{ username }}"
      register: user_check
      ignore_errors: true
    
    - name: Add new user (if not exists)
      community.routeros.command:
        commands:
          - /user add name={{ username }} password={{ password }} group={{ group }} comment="{{ comment }}"
      when: 
        - user_check is succeeded
        - user_check.stdout is defined
        - user_check.stdout | length == 0
      register: user_added
      no_log: true
      ignore_errors: true
    
    - name: Report - User added
      debug:
        msg: "✅ User '{{ username }}' added to {{ company | default(inventory_hostname) }} with group '{{ group }}'"
      when: user_added is changed
    
    - name: Report - User already exists
      debug:
        msg: "⚠️ User '{{ username }}' already exists on {{ company | default(inventory_hostname) }}"
      when: 
        - user_check is succeeded
        - user_check.stdout is defined
        - user_check.stdout | length > 0
    
    - name: Report - Connection error
      debug:
        msg: "❌ Connection failed to {{ company | default(inventory_hostname) }}"
      when: user_check is failed
